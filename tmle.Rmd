---
title: "TMLE"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("function_library.R")
load_all_libraries()
cluster = setup_parallelism()

# Increase to 15 CV folds for estimate_effect()
cv_folds = 15

# Customize ggplot2 default theme.
theme_set(theme_light() + theme(plot.background = element_rect(color = "grey", fill="#f5f5f5")))
```

## Data prep

```{r cache=F}
load("data/analysis-dataset.RData")

# Remove observations with missing data for the outcome.
data_violence = data[!is.na(data$any_violence), ]
data_arrest = data[!is.na(data$any_arrest), ]
rm(data)

# Review dimensions of the outcome-specific datasets.
dim(data_violence)
dim(data_arrest)

# Remove outcomes, assignment, and study id from dataset when creating W dataframe.
W_violence = subset(data_violence, select=-c(any_arrest, treatment, studyid, any_violence))
W_arrest = subset(data_arrest, select=-c(any_arrest, treatment, studyid, any_violence))

# Convert factors to column indicators.
W_violence = data.frame(model.matrix(~ . -1 , W_violence))
W_arrest = data.frame(model.matrix(~ . -1 , W_arrest))

# Review dimensions of the W dataframes.
dim(W_violence)
dim(W_arrest)

```

```{r}
# Set dsa=T to re-enable DSA, but it will slow down the modeling significantly.
custom_lib = create_SL_lib(num_cols = ncol(W_arrest), detailed_names = T)
sl_lib = custom_lib$lib
sl_lib
```

## TMLE

### Arrest analysis

```{r cache=T, eval=T}

system.time({
  # Hide long output from stepAIC.
  out = capture.output({
    # Takes about 5-10 minutes.
    result_arrest = tmle(Y=data_arrest$any_arrest, A=data_arrest$treatment,
                  W=W_arrest, family="binomial",
                  Q.SL.library = sl_lib, g.SL.library = sl_lib)
  })
})

# Very significant reduction in arrest rate.
result_arrest

save(result_arrest, file="data/tmle-arrest.RData")
```

```{r cache=T}
# Compare to manual TMLE.

set.seed(1)
system.time({
  # Takes about 2-10 minutes without outer cross-validation.
  # 10x that with outer cross-validation over 10 folds.
  result_arrest2 = estimate_effect(Y=data_arrest$any_arrest,
                      A=data_arrest$treatment, W=W_arrest,
                      parallel = "multicore", sl_lib = sl_lib,
                      cluster=cluster, cv_folds = cv_folds,
                      crossvalidate=T, outer_cv_folds = 10)
})
result_arrest2

save(result_arrest2, file="data/tmle-arrest2.RData")
```

```{r cache=T}
# We put this in a separate block so that we can modify without invalidating the analysis cache.

# Review SL weights.
result_arrest2$qinit
result_arrest2$ghat

cat("Review distribution of Ghat weights.\n")
summary(result_arrest2$ghat$SL.predict)

qplot(result_arrest2$ghat$SL.predict) + geom_density() + xlab("gHat1W distribution")
ggsave(filename="visuals/ghat-arrest.png")

if ("qinit_cv" %in% names(result_arrest2)) {
	# Review outer cross-validation results.
	print(summary(result_arrest2$qinit_cv))

	print(summary(result_arrest2$ghat_cv))

}
```

```{r cache=T, results="asis"}
# Output the weight tables in a separate block so that we can set results=asis.

if ("qinit_cv" %in% names(result_arrest2)) {
	# Review outer cross-validation results.
  
  # Qinit SL meta-weights
	wgts = cvSL_review_weights(result_arrest2$qinit_cv)
	# Limit to models with a SD > 0.
	wgts = wgts[wgts[, 2] > 0, ]
	# Re-order by descending mean weight.
	wgts = wgts[order(wgts[, 1], decreasing=T), ]
  cat("\nQinit weights:\n")
	print(xtable(wgts), type = "html")

  # ghat SL meta-weights
	wgts = cvSL_review_weights(result_arrest2$ghat_cv)
	# Limit to models with a SD > 0.
	wgts = wgts[wgts[, 2] > 0, ]
	# Re-order by descending mean weight.
	wgts = wgts[order(wgts[, 1], decreasing=T), ]
	 
  cat("\n<br /><br />gHat weights:\n")
	print(xtable(wgts), type = "html")
}
```

### Violence analysis

```{r cache=T, eval=T}


system.time({
  # Hide long output from stepAIC.
  out = capture.output({
    # Takes about 5-10 minutes on CK's laptop.
    result_violence = tmle(Y=data_violence$any_violence, A=data_violence$treatment, W=W_violence, family="binomial", Q.SL.library = sl_lib, g.SL.library = sl_lib)
  })
})

# No effect on violence.
result_violence

save(result_violence, file="data/tmle-violence.RData")

```

```{r cache=T}
set.seed(1)
# Compare to our own code:

system.time({
  # Takes about 2-10 minutes without outer cross-validation.
  # 10x that with outer cross-validation over 10 folds.
  result_violence2 = estimate_effect(Y=data_violence$any_violence, 
                          A=data_violence$treatment, W=W_violence,
                          parallel = "multicore", sl_lib = sl_lib,
                          cv_folds = cv_folds, cluster=cluster,
      	  	  						crossvalidate=T, outer_cv_folds = 10)
})
result_violence2

save(result_violence2, file="data/tmle-violence2.RData")
```

```{r cache=T}
# We put this in a separate block so that we can modify without invalidating the analysis cache.


# Review SL weights.
result_violence2$qinit
result_violence2$ghat

cat("Review distribution of Ghat weights.\n")
summary(result_violence2$ghat$SL.predict)

qplot(result_violence2$ghat$SL.predict) + geom_density() + xlab("gHat1W distribution")
ggsave(filename="visuals/ghat-violence.png")

if ("qinit_cv" %in% names(result_violence2)) {
	# Review outer cross-validation results.
	print(summary(result_violence2$qinit_cv))

	print(summary(result_violence2$ghat_cv))

}

```

```{r cache=T, results="asis"}
# Output the weight tables in a separate block so that we can set results=asis.

if ("qinit_cv" %in% names(result_violence2)) {
	# Review outer cross-validation results.
  
  # Qinit SL meta-weights.
	wgts = cvSL_review_weights(result_violence2$qinit_cv)
	# Limit to models with a SD > 0.
	wgts = wgts[wgts[, 2] > 0, ]
	# Re-order by descending mean weight.
	wgts = wgts[order(wgts[, 1], decreasing=T), ]
  cat("Qinit weights:\n")
	print(xtable(wgts), type = "html")
	
  # gHat SL meta-weights.
	wgts = cvSL_review_weights(result_violence2$ghat_cv)
	# Limit to models with a SD > 0.
	wgts = wgts[wgts[, 2] > 0, ]
	# Re-order by descending mean weight.
	wgts = wgts[order(wgts[, 1], decreasing=T), ]
	
  cat("\n<br /><br />gHat weights:\n")
	print(xtable(wgts), type = "html")
}
```

