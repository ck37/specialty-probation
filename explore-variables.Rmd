---
title: "Explore Variables"
output: html_document
---

```{r setup, include=FALSE}
```

```{r}
library(haven)


data = read_spss("inbound/MASTER Full Probationer Merged Jan 2012.sav")
dim(data)

# Too many columns to list them all.
# paste(names(data), collapse=", ")

head(names(data))
tail(names(data))

# Review distributions of variables that match a string.
review_by_string = function(data, string, ignore_case = T) {
  cols = grep(string, names(data), ignore.case=ignore_case)
  print(names(data)[cols])
  for (col in cols) {
    cat(names(data)[col], ":\n")
    print(summary(data[, col]))
  }
  return(invisible(names(data)[cols]))
}

# Initialize to an empty list.
keep_fields = list()

###################
# Primary participant id.
keep_fields$STUDYID = "studyid"

###################
# OUTCOMES.
review_by_string(data, "AnyFullCONSERV")

###################
# COVARIATES.

# Review possible age fields.
review_by_string(data, "Age")

# Seems reasonable.
table(data$AgeComputed, useNA="ifany")
keep_fields$AgeComputed = "age"

# Review the site fields.
review_by_string(data, "Site", ignore_case=F)

# Average age by site.
# This matches table 1 in Manchak et al. 2014 "High fidelity..."
tapply(data$AgeComputed, data$PB_Site, FUN=function(group) mean(group, na.rm=T))
keep_fields$PB_Site = "site"


review_by_string(data, "Gender")
table(data$PB_Gender1.1, data$PB_Gender3, useNA="ifany")
keep_fields$PB_Gender1.1 = "gender"

review_by_string(data, "Race")
# Looks reasonable but need to determine the codes.
table(data$PB_race1.5)
keep_fields$PB_race1.5 = "race"

review_by_string(data, "probation")

table(data$YRORLESSPROBATION, useNA="ifany")

keep_fields$YRORLESSPROBATION = "year_or_less_probation"

# Index offense or age at first offense?
# May need to calculate age based on this date.
review_by_string(data, "index")
review_by_string(data, "first")
# Still need to figure out index offense.

# Recent violence.
review_by_string(data, "violence")

# Past psychiatric hospitalization.
review_by_string(data, "hospital")

# Colorado symptom index score.
keep_fields$PB_CSITotal = "CSI"

# Global assessment of function
keep_fields$PB_GAFscore21 = "GAF"

# Anxiety subscale of personal assessment inventory.
review_by_string(data, "anxiety")


# Create a new dataset with just the desired fields, which are also renamed.
clean_dataset = function(data, keep_fields) {
  # Create a blank data frame with the correct number of rows.
  clean_data = data.frame(matrix(nrow=nrow(data)))
  # Remove the weird default column that was created.
  clean_data[, 1] = NULL
  dim(clean_data)

  cat("Saving fields... ")
  keep_fields
  names(keep_fields)
  for (name in names(keep_fields)) {
    cat(name, " ")
    clean_data[, keep_fields[[name]]] = data[, name]
  }
  cat("\n")
  cat("New dimensions:", paste(dim(clean_data), collapse=" "), "\n")
  cat("New variables:", paste(names(clean_data), collapse=", "))
  clean_data
}

covariates = clean_dataset(data, keep_fields)

# Convert site from labelled to numeric.
covariates$site = as.numeric(covariates$site)
table(covariates$site, useNA="ifany")

save(covariates, file="data/covariates.RData")

############################################
############################################
# Violence data.
data = read_spss("inbound/FINAL Merged PO and Probationer FULL Violence File_Aug 2014.sav")
names(data)
dim(data)

outcome = review_by_string(data, "AnyFullCONSERV")[1]
outcome

keep_fields = list()
keep_fields[[outcome]] = "any_violence"

tab = table(data[, outcome], useNA="ifany")
tab
prop.table(tab)


assignment = "PB_Site"
tab = table(data[, assignment], useNA="ifany")
tab
prop.table(tab)
keep_fields[[assignment]] = "site"

keep_fields[["STUDYID"]] = "studyid"

violence = clean_dataset(data, keep_fields)
violence$site = as.numeric(violence$site)
table(violence$site)

save(violence, file="data/violence.RData")


############################################
############################################
# Arrest data.
data = read_spss("inbound/FBI Arrests - File 3 - Baseline interview date - Jan 2012.sav")
names(data)
dim(data)

keep_fields = list()
keep_fields$StudyID = "studyid"
keep_fields$PB_site = "site"
keep_fields$anyarrest0to2yr = "any_arrest"

arrest = clean_dataset(data, keep_fields)
arrest$site = as.numeric(arrest$site)

save(arrest, file="data/arrests.RData")

############################################
############################################
# Combined dataset.
library(dplyr)

data = left_join(covariates, violence, by=c("studyid", "site"))
dim(data)
data = left_join(data, arrest, by=c("studyid", "site"))
dim(data)
names(data)

save(data, file="data/analysis-dataset.RData")

```